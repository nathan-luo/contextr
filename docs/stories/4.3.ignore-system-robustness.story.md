# Story 4.3: Enhance Ignore System Robustness

## Status
Draft

## Story
**As a** developer,
**I want** safeguards against accidentally processing large directories,
**so that** contextr doesn't hang or crash when encountering node_modules or similar directories

## Acceptance Criteria
1. .gitignore updated with common large directories (node_modules/, htmlcov/, etc.)
2. Warning system implemented for directories over 1000 files
3. Progress indicators added for operations taking >2 seconds
4. Automatic exclusion of .git/ directory from all traversals
5. Integration tests added for large directory scenarios

## Tasks / Subtasks
- [ ] Task 1: Update .gitignore with common large directories (AC: 1)
  - [ ] Add node_modules/ to .gitignore
  - [ ] Add htmlcov/ (coverage reports)
  - [ ] Add .mypy_cache/ and .ruff_cache/ if not present
  - [ ] Add common IDE directories (.idea/, .vscode/)
  - [ ] Ensure entries follow gitignore best practices
- [ ] Task 2: Implement directory size detection and warnings (AC: 2)
  - [ ] Add `check_directory_size()` method to path_utils.py
  - [ ] Implement configurable threshold (default 1000 files)
  - [ ] Show warning when large directory detected
  - [ ] Provide option to skip or continue with confirmation
  - [ ] Add unit tests for warning system
- [ ] Task 3: Add progress indicators for long operations (AC: 3)
  - [ ] Use Rich Progress for operations over 2 seconds
  - [ ] Add progress tracking to `_add_files()` in manager.py
  - [ ] Show file count and current directory being processed
  - [ ] Add progress to `refresh_files()` and pattern matching
  - [ ] Ensure progress doesn't interfere with normal output
- [ ] Task 4: Implement automatic .git/ exclusion (AC: 4)
  - [ ] Add .git/ as a default ignore pattern in IgnoreManager.__init__
  - [ ] Ensure .git/ is ALWAYS excluded, even if user tries to include it
  - [ ] Add validation to prevent watching .git/ directory
  - [ ] Document this behavior in help text and README
- [ ] Task 5: Create integration tests for large directories (AC: 5)
  - [ ] Create `tests/integration/test_large_directories.py`
  - [ ] Generate test directories with 1k, 10k files
  - [ ] Test warning system triggers correctly
  - [ ] Test progress indicators appear for long operations
  - [ ] Verify performance with large directory structures

## Dev Notes

### Current .gitignore Analysis
[Source: Investigation of .gitignore file]

Current .gitignore is missing several common large directories:
```
# Current content
__pycache__/
*.py[oc]
build/
dist/
wheels/
*.egg-info
.idea/
uv.lock
.venv
.contextr/
```

Missing entries that commonly cause issues:
- `node_modules/` - JavaScript dependencies (can be 100k+ files)
- `htmlcov/` - Coverage HTML reports
- `.mypy_cache/` - MyPy type checking cache
- `.vscode/` - VS Code settings
- `*.log` - Log files that can grow large
- `.DS_Store` - macOS metadata files

### Progress Indicator Implementation
[Source: docs/architecture.md#presentation-layer]

The project uses Rich for terminal output. Rich provides excellent progress tracking:

```python
from rich.progress import Progress, SpinnerColumn, TextColumn, BarColumn

with Progress(
    SpinnerColumn(),
    TextColumn("[progress.description]{task.description}"),
    BarColumn(),
    TextColumn("[progress.percentage]{task.percentage:>3.0f}%"),
) as progress:
    task = progress.add_task("Scanning files...", total=total_files)
    # Update with: progress.update(task, advance=1)
```

### Directory Size Detection Strategy

1. **Quick Check First**: Use `os.scandir()` for fast directory entry counting
2. **Threshold Configuration**: Allow users to set via environment variable or config
3. **Smart Defaults**: Automatically skip known large directories
4. **User Control**: Always allow override with explicit confirmation

Example implementation:
```python
def check_directory_size(path: Path, threshold: int = 1000) -> Tuple[int, bool]:
    """Quick check of directory size. Returns (count, exceeds_threshold)."""
    count = 0
    try:
        with os.scandir(path) as entries:
            for entry in entries:
                count += 1
                if count > threshold:
                    return count, True
    except (OSError, PermissionError):
        return 0, False
    return count, False
```

### Testing Standards
[Source: docs/architecture.md#testing-architecture]
- Integration tests go in `tests/integration/`
- Use `tmp_path` fixture for creating test directories
- Mock time-based operations for progress indicator tests
- Test both interactive and non-interactive modes

### User Experience Considerations

1. **Non-Intrusive Warnings**: Only warn once per session for each large directory
2. **Clear Messages**: Explain WHY the warning appears and what to do
3. **Escape Hatch**: Always provide a way to force inclusion if needed
4. **Performance**: Warnings shouldn't slow down normal operations

### Default Ignore Patterns

Should add these as defaults in `IgnoreManager.__init__`:
- `.git/` - Version control data (ALWAYS excluded)
- `**/__pycache__/` - Python bytecode
- `**/node_modules/` - JavaScript dependencies
- `**/.venv/` and `**/venv/` - Python virtual environments

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-31 | 1.0 | Initial story creation | Bob (SM) |

## Dev Agent Record
### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_