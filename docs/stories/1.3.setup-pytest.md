# Story 1.3: Set Up Pytest Framework

## Status

Done

## Story

**As a** developer,  
**I want** the pytest framework set up,  
**so that** I can write and run automated tests for the application.

## Acceptance Criteria

1. pytest is added as a development dependency.
2. A `tests/` directory is created.
3. pytest can be executed successfully and discovers tests within the `tests/` directory.
4. A simple unit test is created for a utility function (e.g., in `path_utils.py`) that passes when pytest is run.

## Tasks / Subtasks

- [x] Add pytest and related dependencies (AC: 1)
  - [x] Add pytest to pyproject.toml dev dependencies
  - [x] Add pytest-cov for coverage reporting
  - [x] Add pytest-mock for mocking support
  - [x] Install updated dependencies
- [x] Create test directory structure (AC: 2)
  - [x] Create tests/ directory at project root
  - [x] Create tests/__init__.py
  - [x] Create tests/unit/ subdirectory
  - [x] Create tests/integration/ subdirectory
  - [x] Create tests/fixtures/ for test data
  - [x] Add conftest.py for shared fixtures
- [x] Configure pytest (AC: 3)
  - [x] Add [tool.pytest.ini_options] to pyproject.toml
  - [x] Configure test paths and discovery patterns
  - [x] Set up coverage reporting options
  - [x] Verify pytest discovers test directories
- [x] Create initial unit test (AC: 4)
  - [x] Create tests/unit/utils/test_path_utils.py
  - [x] Write test for make_relative function
  - [x] Write test for make_absolute function
  - [x] Ensure tests pass with meaningful assertions
- [x] Document testing setup
  - [x] Update CLAUDE.md with pytest commands
  - [x] Add testing guidelines
  - [x] Document coverage goals

## Dev Notes

### Test Directory Structure

```
tests/
├── __init__.py
├── conftest.py           # Shared fixtures
├── unit/                 # Unit tests
│   ├── __init__.py
│   ├── test_cli.py
│   ├── test_manager.py
│   ├── test_formatters.py
│   └── utils/
│       ├── __init__.py
│       ├── test_path_utils.py
│       └── test_ignore_utils.py
├── integration/          # Integration tests
│   ├── __init__.py
│   └── test_commands.py
└── fixtures/            # Test data
    └── sample_project/
```

### Testing Strategy

- Unit tests for individual functions/methods
- Integration tests for CLI commands
- Mock file system operations where appropriate
- Use fixtures for common test data
- Aim for 80% code coverage initially

### Example Test Pattern

```python
import pytest
from pathlib import Path
from contextr.utils.path_utils import get_relative_path, find_git_root

def test_get_relative_path():
    """Test relative path calculation."""
    base = Path("/home/user/project")
    target = Path("/home/user/project/src/file.py")
    result = get_relative_path(target, base)
    assert result == Path("src/file.py")

def test_find_git_root(tmp_path):
    """Test git root discovery."""
    # Create mock git structure
    git_dir = tmp_path / ".git"
    git_dir.mkdir()

    # Test from subdirectory
    subdir = tmp_path / "src" / "utils"
    subdir.mkdir(parents=True)

    result = find_git_root(subdir)
    assert result == tmp_path
```

### Coverage Configuration

```toml
[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = ["test_*.py", "*_test.py"]
addopts = "--cov=contextr --cov-report=html --cov-report=term"
```

### Testing Standards

- Write tests before fixing bugs
- Each new feature needs tests
- Mock external dependencies
- Use descriptive test names
- Group related tests in classes
- Use parametrize for multiple test cases

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-07-23 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

### Agent Model Used

claude-opus-4-20250514

### Debug Log References

- Initial pytest-mock version 3.15.0 failed due to unavailability, adjusted to 3.14.0
- Fixed multiple linting issues in test files (trailing newlines, whitespace)
- Fixed line length issues in test file method signatures

### Completion Notes List

- Successfully added pytest 8.4.1, pytest-cov 6.2.1, and pytest-mock 3.14.1
- Created complete test directory structure with unit/, integration/, and fixtures/
- Configured pytest with coverage reporting in pyproject.toml
- Created 11 unit tests for path_utils functions, all passing
- Achieved 80% coverage on path_utils.py (meeting the 80% goal)
- Updated CLAUDE.md with testing commands and guidelines

### File List

- pyproject.toml (modified - added pytest dependencies and configuration)
- tests/__init__.py (created)
- tests/conftest.py (created - shared fixtures)
- tests/unit/__init__.py (created)
- tests/unit/utils/__init__.py (created)
- tests/unit/utils/test_path_utils.py (created - 11 unit tests, expanded to 14 tests)
- tests/integration/__init__.py (created)
- CLAUDE.md (modified - added testing commands and guidelines)

## QA Results

### Review Date: 2025-07-23
### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment
Solid pytest setup with well-structured test organization. The developer created a comprehensive testing framework with proper configuration, test discovery, and meaningful initial tests. Test quality is high with good use of fixtures and mocking.

### Refactoring Performed
- **File**: tests/unit/utils/test_path_utils.py
  - **Change**: Added 3 additional test methods covering edge cases
  - **Why**: Initial tests covered 80% of path_utils.py but missed critical functionality
  - **How**: Added tests for IgnoreManager integration, error handling, and environment variable edge cases, improving coverage to 88%

### Compliance Check
- Coding Standards: ✓ Tests follow best practices with descriptive names and proper fixtures
- Project Structure: ✓ Test directory structure matches the documented plan
- Testing Strategy: ✓ Achieves and exceeds the 80% coverage goal
- All ACs Met: ✓ All acceptance criteria satisfied

### Improvements Checklist
- [x] Added tests for IgnoreManager integration in normalize_paths
- [x] Added test for glob pattern error handling
- [x] Added test for environment variables expanding to relative paths
- [x] Fixed all linting and type checking issues in new tests

### Security Review
No security concerns - testing infrastructure properly isolated from production code.

### Performance Considerations
Test suite runs efficiently in ~1.5 seconds. Good use of tmp_path fixtures for filesystem operations.

### Final Status
✓ Approved - Ready for Done
