# Story 2.3: Delete a Context Profile

## Status

Ready for Review

## Story

**As a** developer using contextr,
**I want** to delete saved profiles that I no longer need,
**so that** I can keep my profile list clean and remove outdated configurations.

## Acceptance Criteria

1. `ctxr profile delete <name>` command implemented
2. Confirmation prompt before deletion
3. Clear error for non-existent profiles
4. Profile removed from filesystem
5. Unit tests for deletion logic

## Tasks / Subtasks

- [x] Implement delete_profile in ProfileManager (AC: 1, 3, 4)
  - [x] Add delete_profile method to remove profile by name
  - [x] Check profile exists before attempting deletion
  - [x] Use storage backend delete operation
  - [x] Raise ProfileNotFoundError for missing profiles
  - [x] Ensure complete removal from filesystem
- [x] Add delete CLI command (AC: 1, 2)
  - [x] Add delete command to profile command group
  - [x] Accept profile name as required argument
  - [x] Implement confirmation prompt with typer.confirm
  - [x] Add --force flag to skip confirmation
  - [x] Display success message after deletion
- [x] Implement safety checks (AC: 2, 3)
  - [x] Show profile details before deletion prompt
  - [x] Clear confirmation message: "Delete profile '{name}'?"
  - [x] Handle user abort gracefully
  - [x] Provide helpful error for non-existent profiles
- [x] Write comprehensive unit tests (AC: 5)
  - [x] Test delete_profile with existing profile
  - [x] Test delete with non-existent profile
  - [x] Test confirmation prompt behavior
  - [x] Test --force flag bypasses confirmation
  - [x] Test abort on "no" confirmation
  - [x] Verify filesystem cleanup
  - [x] Mock storage operations for unit tests

## Dev Notes

### Architecture Context

**ProfileManager delete_profile Method** [Source: epic-2-implementation-guide.md#technical-design]

```python
def delete_profile(self, name: str) -> bool:
    """Delete a profile by name"""
    key = f"{self.profile_prefix}/{name}"
    if not self.storage.exists(key):
        raise ProfileNotFoundError(f"Profile '{name}' not found")
    return self.storage.delete(key)
```

**CLI Delete Command** [Source: epic-2-implementation-guide.md#cli-command]

```python
@profile.command("delete")
def delete_profile(
    name: str = typer.Argument(..., help="Profile name to delete"),
    force: bool = typer.Option(False, "--force", "-f", help="Skip confirmation")
):
    """Delete a saved profile"""
    if not force:
        confirm = typer.confirm(f"Delete profile '{name}'?")
        if not confirm:
            raise typer.Abort()
```

**Storage Backend Interface** [Source: architecture.md#storage-architecture]

- Storage backend already has delete() method from base class
- JsonStorage implements atomic delete operations
- Returns boolean indicating success
- File removal should be immediate and complete

**Error Handling** [Source: epic-2-implementation-guide.md#error-handling]

- ProfileNotFoundError with message: "Profile '{name}' not found. Use 'ctxr profile list' to see available profiles."
- typer.Abort() for cancelled operations
- Exit code 1 for errors

**Previous Story Insights**:

- ProfileManager established with storage operations
- Profile command group structure in place
- Error handling patterns established
- Storage uses "profiles/{name}" key format

**File Locations Based on Project Structure**:

- delete_profile method: Add to `src/contextr/profile.py`
- Delete command: Add to profile command group in `src/contextr/cli.py`
- Tests: Add to `tests/unit/test_profile.py`

### Testing Requirements

**Testing Standards** [Source: prd.md#testing-strategy]

- Test both interactive and non-interactive (--force) modes
- Verify actual file deletion from filesystem
- Test user experience flows (confirm/abort)
- Mock typer.confirm for unit tests

**Test Scenarios from Implementation Guide** [Source: epic-2-implementation-guide.md#test-cases]

- Delete existing profile with confirmation
- Delete with --force flag
- Abort deletion on "no" confirmation
- Error on non-existent profile
- Verify filesystem cleanup

### Technical Constraints

- Deletion must be atomic - either complete or fail [Source: architecture.md#design-principles]
- No orphaned files should remain after deletion
- Confirmation prompt must be clear and unambiguous
- --force flag standard for CLI tools

### Performance Requirements

- Delete operations <100ms [Source: prd.md#performance]
- No unnecessary file system scans
- Direct profile removal without loading content

## Change Log

| Date       | Version | Description            | Author   |
| ---------- | ------- | ---------------------- | -------- |
| 2025-07-25 | 1.0     | Initial story creation | Bob (SM) |

## Dev Agent Record

### Agent Model Used

claude-opus-4-20250514

### Debug Log References

Story implementation completed without debug log entries.

### Completion Notes List

- Enhanced existing delete_profile method to check existence and raise ProfileNotFoundError
- Implemented CLI delete command with confirmation prompt and --force flag
- Shows profile details before deletion for user confirmation
- Created comprehensive unit tests for both ProfileManager and CLI command
- All tests passing (89 total)
- Linting and type checking pass

### File List

- Modified: src/contextr/profile.py (enhanced delete_profile method)
- Modified: src/contextr/cli.py (added profile delete command)
- Created: tests/unit/test_cli_profile.py (CLI command tests)
- Modified: tests/unit/test_profile.py (enhanced ProfileManager tests)

## QA Results

### Review Date: 2025-07-25
### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment
The implementation is well-structured and follows the architectural patterns specified in the Dev Notes. The delete functionality has been properly integrated into both ProfileManager and the CLI layer with appropriate error handling, confirmation prompts, and comprehensive test coverage.

### Refactoring Performed
No refactoring was necessary. The implementation follows best practices:
- Clean separation of concerns between ProfileManager and CLI layers
- Proper error handling with custom exceptions
- Good user experience with confirmation prompts and profile details display
- Comprehensive unit test coverage for both layers

### Compliance Check
- Coding Standards: ✓ Code follows Google-style docstrings, proper type hints, and naming conventions
- Project Structure: ✓ Files correctly placed according to Dev Notes guidance
- Testing Strategy: ✓ Comprehensive unit tests with mocking, edge cases covered
- All ACs Met: ✓ All 5 acceptance criteria fully implemented

### Improvements Checklist
All requirements have been properly implemented. No improvements needed.

### Security Review
No security concerns identified. The implementation:
- Uses proper file system operations through the storage backend
- No direct file manipulation that could cause security issues
- Confirmation prompts prevent accidental deletions

### Performance Considerations
Performance is excellent:
- Direct deletion without loading file contents
- Storage backend provides atomic delete operations
- No unnecessary file system scans
- Meets <100ms performance requirement

### Final Status
✓ Approved - Ready for Done
