# Story 4.1: Optimize CI/CD Workflow Configuration

## Status

Ready for Review

## Story

**As a** developer,
**I want** CI tests to run only on PRs to main branch,
**so that** I can push commits quickly without waiting for unnecessary test runs on feature branches

## Acceptance Criteria

1. Full test suite (pytest, coverage) runs ONLY on pull requests targeting main branch
2. Formatting and linting checks removed from all branches except PRs to main
3. Release workflow remains unchanged (triggers on version tags)
4. Pre-commit framework installed with ruff format, ruff check, and pyright hooks
5. Developer documentation updated with new workflow

## Tasks / Subtasks

- [x] Task 1: Modify GitHub Actions CI workflow (AC: 1, 2)
  - [x] Update .github/workflows/ci.yml to trigger only on PRs to main
  - [x] Remove push triggers for main and dev branches
  - [x] Keep pull_request trigger only for main branch target
  - [x] Remove all test/lint/format jobs from non-main PR workflows
- [x] Task 2: Verify release workflow unchanged (AC: 3)
  - [x] Confirm .github/workflows/release.yml still triggers on v*.*.\* tags
  - [x] Test that release workflow is unaffected by CI changes
- [x] Task 3: Implement pre-commit framework (AC: 4)
  - [x] Create .pre-commit-config.yaml with hooks configuration
  - [x] Add pre-commit to dev dependencies in pyproject.toml
  - [x] Configure hooks: ruff format, ruff check, pyright
  - [x] Test pre-commit hooks work correctly
- [x] Task 4: Update documentation (AC: 5)
  - [x] Update README.md with new workflow information
  - [x] Add section about pre-commit setup for developers
  - [x] Document how to bypass pre-commit if needed (--no-verify)
  - [x] Update CLAUDE.md with new local validation workflow

## Dev Notes

### Testing Standards

[Source: docs/architecture.md#testing-architecture]

- Test file location: tests/ directory with unit/ and integration/ subdirectories
- Test framework: pytest with pytest-mock for mocking
- Coverage reporting: pytest-cov with minimum 80% target (currently 70%)
- Test naming: Descriptive test names explaining what is being tested
- Fixtures: Shared fixtures in conftest.py

### GitHub Actions Configuration

Current CI workflow location: `.github/workflows/ci.yml`
[Source: Investigation of actual file system]

Current triggers:

```yaml
on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
```

Must be changed to:

```yaml
on:
  pull_request:
    branches: [main]
```

### Pre-commit Configuration

[Source: docs/architecture.md#code-quality-standards]
The project uses:

- **Ruff**: For formatting (88 char line length) and linting (F, E/W, I rules)
- **Pyright**: For strict type checking (100% type coverage target)

Pre-commit config should include:

```yaml
repos:
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.8.6 # Use latest stable version
    hooks:
      - id: ruff-format
      - id: ruff
  - repo: https://github.com/microsoft/pyright
    rev: v1.1.394 # Use latest stable version
    hooks:
      - id: pyright
```

### Development Dependencies

[Source: Investigation of pyproject.toml]
Current dev dependencies use `uv` package manager. Add pre-commit to the dev group:

```toml
[tool.uv.dependency-groups.dev]
dependencies = [
    # existing deps...
    "pre-commit>=4.0.1",
]
```

### Important Notes from Investigation

- No existing pre-commit hooks are configured (only .sample files in .git/hooks/)
- The project already has all the tools (ruff, pyright) installed, just needs pre-commit integration
- Current CI runs on EVERY push and PR to main/dev, causing excessive test runs
- Windows compatibility has been fixed in recent commits (path separator issues)

## Change Log

| Date       | Version | Description            | Author   |
| ---------- | ------- | ---------------------- | -------- |
| 2025-07-31 | 1.0     | Initial story creation | Bob (SM) |
| 2025-08-01 | 1.1     | Story completed        | James (Dev) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4 (claude-opus-4-20250514)

### Debug Log References

- Modified CI workflow to trigger only on PRs to main
- Verified release workflow remains unchanged
- Implemented pre-commit framework with ruff and pyright hooks
- Resolved pyright version issue by using local hook configuration
- Updated README.md and CLAUDE.md with new workflow documentation

### Completion Notes List

- CI workflow now only runs on PRs to main branch, reducing unnecessary test runs
- Pre-commit hooks installed for local validation (ruff-format, ruff, pyright)
- Pyright hook configured as local hook due to version tagging differences
- Documentation updated in both README.md and CLAUDE.md
- All tests passing (120 tests, 70% coverage)
- Pre-commit hooks tested and working correctly

### File List

- Modified: .github/workflows/ci.yml
- Created: .pre-commit-config.yaml
- Modified: pyproject.toml
- Modified: README.md
- Modified: CLAUDE.md

## QA Results

_To be populated by QA agent_
