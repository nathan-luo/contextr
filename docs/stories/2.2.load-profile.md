# Story 2.2: Load a Context Profile

## Status

Draft

## Story

**As a** developer using contextr,
**I want** to load a previously saved profile to replace my current context,
**so that** I can quickly switch between different project contexts without manually reconfiguring patterns.

## Acceptance Criteria

1. `ctxr profile load <name>` command implemented
2. Current context cleared before loading
3. File list automatically refreshed after load
4. Error handling for non-existent profiles
5. Profile loading is idempotent
6. Unit tests for load mechanism

## Tasks / Subtasks

- [ ] Implement load_profile in ProfileManager (AC: 1, 4)
  - [ ] Add load_profile method to retrieve profile by name
  - [ ] Validate profile exists before loading
  - [ ] Deserialize profile data from storage
  - [ ] Handle ProfileNotFoundError gracefully
  - [ ] Return Profile object with all data
- [ ] Add apply_profile to ContextManager (AC: 2, 3, 5)
  - [ ] Create apply_profile method that accepts Profile object
  - [ ] Clear current watched and ignore patterns
  - [ ] Apply profile patterns to context
  - [ ] Trigger automatic file refresh after pattern update
  - [ ] Ensure idempotent behavior (loading same profile multiple times)
- [ ] Implement load CLI command (AC: 1)
  - [ ] Add load command to profile command group
  - [ ] Accept profile name as required argument
  - [ ] Display success message with loaded patterns summary
  - [ ] Show helpful error for missing profiles
  - [ ] Use Rich console for formatted output
- [ ] Add profile validation (AC: 4)
  - [ ] Validate profile data structure on load
  - [ ] Check for required fields (name, patterns)
  - [ ] Handle corrupted profile files gracefully
  - [ ] Provide clear error messages for validation failures
- [ ] Write comprehensive unit tests (AC: 6)
  - [ ] Test load_profile with existing profile
  - [ ] Test load_profile with non-existent profile
  - [ ] Test apply_profile clears previous context
  - [ ] Test file refresh triggered after load
  - [ ] Test idempotent loading behavior
  - [ ] Test error handling and validation
  - [ ] Mock storage and file system operations

## Dev Notes

### Architecture Context

**ProfileManager load_profile Method** [Source: epic-2-implementation-guide.md#technical-design]
```python
def load_profile(self, name: str) -> Profile:
    """Load a profile by name"""
    key = f"{self.profile_prefix}/{name}"
    data = self.storage.load(key)
    if not data:
        raise ProfileNotFoundError(f"Profile '{name}' not found")
    return Profile.from_dict(data)
```

**ContextManager apply_profile Method** [Source: epic-2-implementation-guide.md#technical-design]
```python
def apply_profile(self, profile: Profile) -> None:
    """Replace current context with profile data"""
    self.clear()
    self.watched_patterns = set(profile.watched_patterns)
    self.ignore_patterns = set(profile.ignore_patterns)
    self.refresh_files()
```

**Profile Data Model** [Source: epic-2-implementation-guide.md#data-models]
- Profile class with from_dict classmethod for deserialization
- Contains: name, watched_patterns, ignore_patterns, metadata
- Metadata includes created_at, updated_at, optional description
- All timestamp fields use ISO format strings

**Error Handling** [Source: epic-2-implementation-guide.md#error-handling]
- Custom exception: ProfileNotFoundError extends ProfileError
- Error message format: "Profile '{name}' not found. Use 'ctxr profile list' to see available profiles."
- CLI should catch exceptions and display user-friendly messages

**Previous Story Insights from Story 2.1**:
- ProfileManager class structure established
- Storage operations use "profiles/{name}" key format
- Profile validation logic will be in place
- CLI command group structure already created

**File Locations Based on Project Structure**:
- Profile exceptions: Add to `src/contextr/profile.py`
- apply_profile method: Add to `src/contextr/manager.py`
- Load command: Add to profile command group in `src/contextr/cli.py`
- Tests: Add to `tests/unit/test_profile.py`

### Testing Requirements

**Testing Standards** [Source: prd.md#testing-strategy]
- Integration tests should verify full workflow
- Test idempotent behavior explicitly
- Mock ContextManager for unit testing ProfileManager
- Use real ContextManager for integration tests

**Test Scenarios from Implementation Guide** [Source: epic-2-implementation-guide.md#test-cases]
- Load existing profile successfully
- Error on non-existent profile
- Verify context cleared before load
- Confirm files refreshed after load
- Test idempotent loading

### Technical Constraints

- Maintain backward compatibility with existing commands [Source: prd.md#compatibility]
- Profile operations must be atomic [Source: architecture.md#design-principles]
- Clear operation must not affect profile storage
- File refresh must use existing ContextManager logic

### Performance Requirements

- Profile load operations <100ms [Source: prd.md#performance]
- File refresh should not re-scan if patterns unchanged (idempotent)
- Minimize file I/O operations during load

## Change Log

| Date       | Version | Description                        | Author    |
|------------|---------|-----------------------------------|-----------|
| 2025-07-25 | 1.0     | Initial story creation            | Bob (SM)  |

## Dev Agent Record

### Agent Model Used

_To be populated by development agent_

### Debug Log References

_To be populated by development agent_

### Completion Notes List

_To be populated by development agent_

### File List

_To be populated by development agent_

## QA Results

_To be populated by QA agent_