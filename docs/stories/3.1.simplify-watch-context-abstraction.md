# Story 3.1: Simplify Watch/Context Abstraction

## Status

Done

## Story

**As a** developer using contextr,
**I want** the context to automatically sync with watched patterns without managing them separately,
**so that** I have a simpler mental model where I only manage what I watch and context follows automatically.

## Acceptance Criteria

1. Context files automatically sync with watched patterns (no separate add/remove commands needed)
2. Watched patterns act as the single source of truth for context files
3. Removing a watch pattern automatically removes associated files from context
4. Adding a watch pattern automatically adds matching files to context
5. The `sync` command refreshes files based solely on watched patterns
6. Unit tests for new auto-sync behavior

## Tasks / Subtasks

- [x] Refactor ContextManager to auto-sync context with watched patterns (AC: 1, 2, 3, 4)

  - [x] Make add_files and remove_files internal-only methods (prefix with underscore)
  - [x] Update watch_paths to automatically add matching files after adding patterns
  - [x] Update unwatch_paths to automatically remove associated files after removing patterns
  - [x] Ensure \_save_state always keeps files in sync with watched patterns
  - [x] Update refresh_files to be the primary sync mechanism

- [x] Remove standalone file management commands from CLI (AC: 1, 2)

  - [x] Remove `add` command if it exists
  - [x] Remove `remove` command if it exists
  - [x] Update help text to clarify that files are managed through watch patterns

- [x] Update sync command for new behavior (AC: 5)

  - [x] Ensure sync only refreshes from watched patterns
  - [x] Update command description to reflect new behavior
  - [x] Add clear output showing what files were added/removed during sync

- [x] Update profile system for new behavior (AC: 2)

  - [x] Ensure profile save captures only watched patterns (not files)
  - [x] Ensure profile load triggers automatic file sync
  - [x] Update apply_profile to use refresh_files after setting patterns
  - [x] Verify profiles work correctly with the simplified model

- [x] Write comprehensive unit tests (AC: 6)
  - [x] Test auto-sync behavior when adding watch patterns
  - [x] Test auto-sync behavior when removing watch patterns
  - [x] Test that context stays in sync with watched patterns
  - [x] Test edge cases (empty patterns, invalid patterns, overlapping patterns)
  - [x] Update existing tests that rely on old behavior
  - [x] Test profile save/load with auto-sync

## Dev Notes

### Architecture Context

**Current State Analysis**:

- ContextManager currently maintains separate `files` and `watched_patterns` sets
- Files can be added/removed independently of watch patterns
- This creates confusion about the relationship between watched patterns and context
- Users need to understand two concepts: what they're watching and what's in context

**Simplification Goals**:

- Watch patterns become the single source of truth
- Context files are always derived from watched patterns
- No manual file management needed
- Clearer mental model: "I watch patterns, context contains matching files"

**Key Changes to ContextManager**:

1. Make `add_files` and `remove_files` private methods (prefix with underscore)
2. Always call `refresh_files` after modifying watched patterns
3. Remove the ability to have files without watched patterns
4. Ensure all file operations go through watch pattern management

**Implementation Strategy**:

1. Start by refactoring ContextManager methods to enforce auto-sync
2. Update all CLI commands to work with the new model
3. Remove unnecessary commands that directly manipulate files
4. Update all tests to reflect the new behavior
5. Ensure backward compatibility for existing saved states

### Testing Requirements

**Test Scenarios**:

- Watch pattern addition immediately adds matching files
- Watch pattern removal immediately removes associated files
- Context cannot have files without corresponding watch patterns
- Sync command refreshes based on current patterns
- Profile operations work with auto-sync behavior
- Multiple overlapping patterns handle files correctly

**Edge Cases**:

- Watch patterns that match no files
- Overlapping watch patterns (file matched by multiple patterns)
- Patterns that are also in ignore list
- Invalid glob patterns
- Empty watch pattern list

### Technical Constraints

- Must maintain backward compatibility with existing saved states
- Profile format should remain compatible (only patterns saved)
- Storage abstraction must continue to work
- Performance must not degrade with auto-sync
- All changes must pass Ruff linting and Pyright strict type checking

### Performance Requirements

- Auto-sync operations should be efficient
- File scanning should use existing ignore logic
- No redundant file system operations
- Batch operations where possible
- Sync operations should complete in <500ms for typical projects

## Change Log

| Date       | Version | Description                   | Author            |
| ---------- | ------- | ----------------------------- | ----------------- |
| 2025-07-26 | 1.0     | Initial story creation        | Claude            |
| 2025-07-26 | 1.1     | Story implementation complete | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4 (claude-opus-4-20250514)

### Debug Log References

- Refactored ContextManager to make add_files and remove_files private methods
- Updated watch_paths and unwatch_paths to auto-sync files with patterns
- Modified refresh_files to be the primary sync mechanism
- Updated CLI commands to reflect new behavior
- Fixed existing tests that depended on public add_files method
- Created comprehensive test suite for auto-sync behavior

### Completion Notes List

- Created Story 3.1 focused on simplifying the watch/context abstraction
- Removed separate context management concept in favor of auto-sync
- This change will make the tool more intuitive and reduce cognitive load
- Successfully implemented auto-sync behavior where files automatically follow watched patterns
- All tests pass (102 tests) with increased coverage to 64%
- Linting and type checking pass without errors

### File List

- /home/natha/dev/contextr/docs/stories/3.1.simplify-watch-context-abstraction.md (created)
- /home/natha/dev/contextr/src/contextr/manager.py (modified)
- /home/natha/dev/contextr/src/contextr/cli.py (modified)
- /home/natha/dev/contextr/tests/unit/test_manager_auto_sync.py (created)
- /home/natha/dev/contextr/tests/unit/test_manager_storage.py (modified)

## QA Results

### Review Date: 2025-07-26

### Reviewer: Quinn (QA Engineer)

### Review Status: APPROVED WITH MINOR OBSERVATIONS

#### Code Quality Review

**Architecture & Design**:

- ✅ Successfully simplified the mental model by making watched patterns the single source of truth
- ✅ Removed confusion between watched patterns and context files
- ✅ Made `add_files` and `remove_files` private methods (prefixed with underscore)
- ✅ Proper separation of concerns with auto-sync behavior

**Implementation Quality**:

- ✅ All acceptance criteria met (AC 1-6)
- ✅ Clean refactoring with minimal changes to public API
- ✅ Backward compatibility maintained for existing saved states
- ✅ Profile system properly updated to work with auto-sync

**Code Standards**:

- ✅ Type hints properly maintained (passes Pyright strict mode)
- ✅ Follows project style guidelines (passes Ruff linting)
- ✅ Good method documentation with clear Args/Returns sections

#### Testing Review

**Test Coverage**:

- ✅ Comprehensive unit tests added (13 new tests in test_manager_auto_sync.py)
- ✅ All tests passing (102 total tests)
- ✅ Coverage increased to 64% (from 62%)
- ✅ Edge cases properly tested:
  - Empty patterns
  - Invalid patterns
  - Overlapping patterns
  - Profile operations with auto-sync

**Test Quality**:

- ✅ Tests are well-structured and isolated
- ✅ Good use of fixtures for test setup
- ✅ Clear test names that describe behavior
- ✅ Tests verify both positive and negative scenarios

#### Functional Testing

**Manual Testing Results**:

- ✅ Watch command automatically adds matching files
- ✅ Unwatch command removes associated files
- ✅ Sync command properly refreshes based on patterns
- ✅ Profile save/load works correctly with auto-sync
- ⚠️ Minor UI observation: unwatch command output shows "Keeping X existing files" which might be confusing since files are actually removed (cosmetic issue only)

#### Performance & Security

**Performance**:

- ✅ No performance degradation observed
- ✅ Efficient implementation using existing ignore logic
- ✅ Batch operations properly utilized

**Security**:

- ✅ No security concerns identified
- ✅ File access properly controlled through existing mechanisms

#### Recommendations

1. **Minor UI Enhancement**: Consider updating the unwatch command output message to better reflect that files are being removed when patterns are unwatched.

2. **Documentation**: Update user-facing documentation to clearly explain the new simplified model where files automatically follow watched patterns.

3. **Future Enhancement**: Consider adding a `--dry-run` flag to watch/unwatch commands to preview what files would be added/removed.

#### Summary

This is a well-executed refactoring that successfully simplifies the user experience while maintaining backward compatibility. The code quality is high, tests are comprehensive, and the implementation is clean. The auto-sync behavior works as expected and makes the tool more intuitive to use.

**Verdict**: APPROVED ✅

The minor observation about the unwatch command output message is cosmetic and does not affect functionality. This can be addressed in a future story if desired.
